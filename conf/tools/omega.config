/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
----------------------------------------------------------------------------------------
*/

process {

    withName: 'SUBSETOMEGA' {
        ext.filters     = { ['"TYPE" : "SNV"'].join(',\t').trim()
                        }
        ext.output_fmt  = { ['"header": true',
                                '"columns": ["CHROM", "POS", "REF", "ALT", "SAMPLE_ID"]',
                                '"colnames": ["CHROM", "POS", "REF", "ALT", "SAMPLE_ID"]'
                            ].join(',\t').trim()
                        }

        publishDir       = [
                enabled : false
        ]
    }


    withName: '.*MULTI:SUBSETOMEGA' {
        ext.filters     = { ['"TYPE" : "SNV"'].join(',\t').trim()
                        }
        ext.output_fmt  = { ['"header": true',
                                '"columns": ["CHROM", "POS", "REF", "ALT", "SAMPLE_ID", "ALT_DEPTH"]',
                                '"colnames": ["CHROM", "POS", "REF", "ALT", "SAMPLE_ID", "EFFECTIVE_MUTS"]'
                            ].join(',\t').trim()
                        }

        publishDir       = [
                enabled : false
        ]
    }


    withName: "BBG_DEEPCSA:OMEGAMULTI:.*" {
            ext.prefix       = { "${meta.id}.multi" }
    }

    withName: "BBG_DEEPCSA:OMEGANONPROTMULTI:.*" {
            ext.prefix       = { "${meta.id}.non_prot_aff.multi" }
    }


    withName: "BBG_DEEPCSA:OMEGA:.*GLOBALLOC" {
            ext.prefix       = { "${meta.id}.global_loc" }
    }

    withName: "BBG_DEEPCSA:OMEGAMULTI:.*GLOBALLOC" {
            ext.prefix       = { "${meta.id}.multi.global_loc" }
    }

    withName: "BBG_DEEPCSA:OMEGANONPROT:.*GLOBALLOC" {
            ext.prefix       = { "${meta.id}.non_prot_aff.global_loc" }
    }

    withName: "BBG_DEEPCSA:OMEGANONPROTMULTI:.*GLOBALLOC" {
            ext.prefix       = { "${meta.id}.non_prot_aff.multi.global_loc" }
    }


    withName: 'PREPROCESSING' {
        ext.args        = ""
        publishDir       = [
            [
                mode: params.publish_dir_mode,
                path: { "${params.outdir}/omega/preprocessing" },
                pattern: "*{tsv}"
            ]
//                enabled : false
        ]
    }

    withName: 'ESTIMATOR' {
        ext.option      = 'mle'
        ext.args        = ""
        publishDir       = [
            [
                mode: params.publish_dir_mode,
                path: { "${params.outdir}/omega" },
                pattern: "*{tsv}"
            ]
        ]
    }

    withName: 'PLOTOMEGA' {
        ext.args        = ""
        publishDir       = [
            [
                mode: params.publish_dir_mode,
                path: { "${params.outdir}/omega/plot" },
                pattern: "**{pdf}"
            ]
        ]
    }

    if (params.omega_globalloc){
        withName: 'PREPROCESSINGGLOBALLOC' {
            ext.args        = ""
            ext.global_loc  = true
            publishDir       = [
                [
                    mode: params.publish_dir_mode,
                    path: { "${params.outdir}/omegagloballoc/preprocessing" },
                    pattern: "*{tsv}"
                ]
            ]
        }

        withName: 'ESTIMATORGLOBALLOC' {
            ext.option      = 'mle'
            ext.args        = ""
            publishDir       = [
                [
                    mode: params.publish_dir_mode,
                    path: { "${params.outdir}/omegagloballoc" },
                    pattern: "*{tsv}"
                ]
            ]
        }

        withName: 'PLOTOMEGAGLOBALLOC' {
            ext.args        = ""
            publishDir       = [
                [
                    mode: params.publish_dir_mode,
                    path: { "${params.outdir}/omegagloballoc/plot" },
                    pattern: "**{pdf}"
                ]
            ]
        }
    }

    if (params.omega_vaf_distorsioned){
        withName: 'PREPROCESSINGRED' {
            ext.args        = ""
            publishDir       = [
                [
                    mode: params.publish_dir_mode,
                    path: { "${params.outdir}/omegareduced/preprocessing" },
                    pattern: "*{tsv}"
                ]
            ]
        }

        withName: 'ESTIMATORRED' {
            ext.option      = 'mle'
            ext.args        = ""
            publishDir       = [
                [
                    mode: params.publish_dir_mode,
                    path: { "${params.outdir}/omegareduced" },
                    pattern: "*{tsv}"
                ]
            ]
        }
        withName: 'SUBSETOMEGA_REDUCED' {
            ext.filters     = { ['"TYPE" : "SNV"',
                                    '"VAF_distorted_reduced" : true',
                                    ].join(',\t').trim()
                            }
            ext.output_fmt  = { ['"header": true',
                                    '"columns": ["CHROM", "POS", "REF", "ALT", "SAMPLE_ID"]',
                                    '"colnames": ["CHROM", "POS", "REF", "ALT", "SAMPLE_ID"]'
                                ].join(',\t').trim()
                            }

            publishDir       = [
                    enabled : false
            ]
        }

        withName: 'PREPROCESSINGEXP' {
            ext.args        = ""
            publishDir       = [
                [
                    mode: params.publish_dir_mode,
                    path: { "${params.outdir}/omegaexpanded/preprocessing" },
                    pattern: "*{tsv}"
                ]
            ]
        }

        withName: 'ESTIMATOREXP' {
            ext.option      = 'mle'
            ext.args        = ""
            publishDir       = [
                [
                    mode: params.publish_dir_mode,
                    path: { "${params.outdir}/omegaexpanded" },
                    pattern: "*{tsv}"
                ]
            ]
        }
        withName: 'SUBSETOMEGA_EXPANDED' {
            ext.filters     = { ['"TYPE" : "SNV"',
                                    '"VAF_distorted_expanded" : true',
                                    ].join(',\t').trim()
                            }
            ext.output_fmt  = { ['"header": true',
                                    '"columns": ["CHROM", "POS", "REF", "ALT", "SAMPLE_ID"]',
                                    '"colnames": ["CHROM", "POS", "REF", "ALT", "SAMPLE_ID"]'
                                ].join(',\t').trim()
                            }

            publishDir       = [
                    enabled : false
            ]
        }

        withName: 'PREPROCESSINGOK' {
            ext.args        = ""
            publishDir       = [
                [
                    mode: params.publish_dir_mode,
                    path: { "${params.outdir}/omegaok/preprocessing" },
                    pattern: "*{tsv}"
                ]
            ]
        }

        withName: 'ESTIMATOROK' {
            ext.option      = 'mle'
            ext.args        = ""
            publishDir       = [
                [
                    mode: params.publish_dir_mode,
                    path: { "${params.outdir}/omegaok" },
                    pattern: "*{tsv}"
                ]
            ]
        }
        withName: 'SUBSETOMEGA_OK' {
            ext.filters     = { ['"TYPE" : "SNV"',
                                    '"VAF_distorted" : false',
                                    ].join(',\t').trim()
                            }
            ext.output_fmt  = { ['"header": true',
                                    '"columns": ["CHROM", "POS", "REF", "ALT", "SAMPLE_ID"]',
                                    '"colnames": ["CHROM", "POS", "REF", "ALT", "SAMPLE_ID"]'
                                ].join(',\t').trim()
                            }

            publishDir       = [
                    enabled : false
            ]
        }
    }




    if (params.vep_genome == 'GRCh38') {
        withName: 'PREPROCESSING.*|ESTIMATOR.*' {
                ext.assembly    = 'hg38'
        }
    } else if (params.vep_genome == 'GRCm38') {
            withName: 'PREPROCESSING.*|ESTIMATOR.*' {
                ext.assembly    = 'mm10'
        }
    } else if (params.vep_genome == 'GRCm39') {
        withName: 'PREPROCESSING.*|ESTIMATOR.*' {
                ext.assembly    = 'mm39'
        }
    }

}
