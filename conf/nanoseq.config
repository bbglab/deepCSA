process {
    // === RESOURCE LIMITS ===
    resourceLimits = [ 
        cpus: params.max_cpus ?: 196, 
        memory: params.max_memory ?: 950.GB, 
        time: params.max_time ?: 30.d 
    ]

    // === SENSIBLE DEFAULTS ===
    // Most processes use minimal resources based on usage analysis
    cpus   = { 1 }
    memory = { 2.GB * task.attempt }
    time   = { 30.min * task.attempt }

    // === ERROR HANDLING ===
    errorStrategy = { 
        if (task.exitStatus in ((130..145) + 104)) {
            sleep(Math.pow(2, task.attempt) * 200 as long)  // Exponential backoff
            return 'retry'
        } else {
            return 'finish'
        }
    }
    maxRetries = 3
    maxErrors  = '-1'

    withLabel:error_ignore {
        errorStrategy = 'ignore'
    }
    withLabel:error_retry {
        errorStrategy = 'retry'
        maxRetries    = 2
    }

    // === PANEL CREATION PROCESSES ===
    // Large memory requirements for genomic position processing
    withName: 'BBGTOOLS:DEEPCSA:CREATEPANELS:SITESFROMPOSITIONS' {
        memory = { 80.GB * task.attempt }
        time   = { 30.min * task.attempt }
    }

    // VEP annotation is CPU and memory intensive for large VCFs
    withName: 'BBGTOOLS:DEEPCSA:CREATEPANELS:VCFANNOTATEPANEL:ENSEMBLVEP_VEP*' {
        cpus   = { 24 * task.attempt }
        memory = { 24.GB * task.attempt }
        time   = { 32.h * task.attempt }
    }

    withName: 'BBGTOOLS:DEEPCSA:CREATEPANELS:CUSTOMPROCESSING.*' {
        memory = { 16.GB * task.attempt }
        time   = { 1.h * task.attempt }
    }

    withName: 'BBGTOOLS:DEEPCSA:DEPTHS.*CONS' {
        cpus   = { 2 * task.attempt }
        memory = { 8.GB * task.attempt }
    }

    withName: 'BBGTOOLS:DEEPCSA:CREATEPANELS:CREATECAPTUREDPANELS*' {
        memory = { 10.GB * task.attempt }
    }

    // Large consensus panels require substantial memory
    withName: 'BBGTOOLS:DEEPCSA:CREATEPANELS:CREATECONSENSUSPANELS.*' {
        memory = { 32.GB * task.attempt }
        time   = { 10.min * task.attempt }
    }

    // === ANALYSIS PROCESSES ===
    withName: 'BBGTOOLS:DEEPCSA:ANNOTATEDEPTHS*' {
        memory = { 20.GB * task.attempt }
        time   = { 1.h * task.attempt }
    }

    withName: '(BBGTOOLS:DEEPCSA:MUT_PREPROCESSING:SUMANNOTATION*|BBGTOOLS:DEEPCSA:CREATEPANELS:DOMAINANNOTATION*)' {
        cpus   = { 2 * task.attempt }
        memory = { 10.GB * task.attempt }
    }

    withName:'BBGTOOLS:DEEPCSA:MUT_PREPROCESSING:PLOTMAF*' {
        memory = { 16.GB * task.attempt }
        time   = { 15.min * task.attempt }
    }

    withName: '(BBGTOOLS:DEEPCSA:CREATEPANELS:POSTPROCESSVEPPANEL*|BBGTOOLS:DEEPCSA:MUT_PREPROCESSING:SOMATICMUTATIONS*|BBGTOOLS:DEEPCSA:OMEGANONPROT.*:SUBSETPANEL*)' {
        cpus   = { 2 * task.attempt }
        memory = { 4.GB * task.attempt }
        time   = { 360.min * task.attempt }
    }

    withName: 'BBGTOOLS:DEEPCSA:MUTRATE.*:MUTRATE*' {
        memory = { 8.GB * task.attempt }
    }

    withName: '(BBGTOOLS:DEEPCSA:OMEGA.*:(PREPROCESSING|ESTIMATOR).*|BBGTOOLS:DEEPCSA:MUT_PREPROCESSING:FILTERBATCH|BBGTOOLS:DEEPCSA:MUT_PREPROCESSING:WRITEMAF|BBGTOOLS:DEEPCSA:MULTIQC)' {
        memory = { 4.GB * task.attempt }
    }

    //withName: 'BBGTOOLS:DEEPCSA:SIGNATURESNONPROT:SIGPROFILERASSIGNMENT*' {
    //    memory = { 2.GB * task.attempt }
    //}

    withName: '(BBGTOOLS:DEEPCSA:MUTRATE.*:SUBSETMUTRATE|BBGTOOLS:DEEPCSA:OMEGA.*:SUBSETOMEGA.*|BBGTOOLS:DEEPCSA:MUTPROFILE.*:COMPUTEMATRIX|BBGTOOLS:DEEPCSA:DNA2PROTEINMAPPING|BBGTOOLS:DEEPCSA:SIGNATURES.*:MATRIXCONCATWGS|BBGTOOLS:DEEPCSA:SYNMUTRATE|BBGTOOLS:DEEPCSA:SYNMUTREADSRATE|BBGTOOLS:DEEPCSA:SIGNATURES.*:SIGPROFILERASSIGNMENT|BBGTOOLS:DEEPCSA:OMEGA.*:GROUPGENES|BBGTOOLS:DEEPCSA:SIGNATURES.*:SIGPROBS|BBGTOOLS:DEEPCSA:MUTS2SIGS|BBGTOOLS:DEEPCSA:CUSTOM_DUMPSOFTWAREVERSIONS|BBGTOOLS:DEEPCSA:TABLE2GROUP|BBGTOOLS:DEEPCSA:INPUT_CHECK:SAMPLESHEET_CHECK|BBGTOOLS:DEEPCSA:DEPTHANALYSIS:COMPUTEDEPTHS)' {
        memory = { 500.MB * task.attempt }
    }

    withName: '(BBGTOOLS:DEEPCSA:MUTPROFILE.*:COMPUTETRINUC|BBGTOOLS:DEEPCSA:MUTPROFILE.*:COMPUTEPROFILE)' {
        memory = { 1.GB * task.attempt }
    }

    // === UTILITY PROCESSES ===
    withName: 'BBGTOOLS:DEEPCSA:CUSTOM_DUMPSOFTWAREVERSIONS*' {
        cache = false
    }

    }